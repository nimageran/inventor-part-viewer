<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Inventor Part Scanner - Column 2 Fixed</title>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@400;600&family=Inter:wght@300;400;600&display=swap');

    /* ------------------------------------------------------------------
       THEME VARIABLES
       ------------------------------------------------------------------ */
    :root {
      /* Default to LIGHT THEME variables initially */
      --bg-gradient: radial-gradient(circle at top, #f8fafc 0, #e2e8f0 100%);
      --grid-color: rgba(0, 0, 0, 0.05);
      --text-main: #1e293b;
      --text-muted: #64748b;
      --text-accent: #0284c7;
      
      --panel-bg: rgba(255, 255, 255, 0.90);
      --panel-border: rgba(148, 163, 184, 0.4);
      --panel-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
      
      --brand-font: "Orbitron", sans-serif;
      --body-font: "Inter", sans-serif;
      
      --button-bg: #e2e8f0;
      --button-hover: #cbd5e1;
      --button-text: #0f172a;
      
      --highlight-color: #0ea5e9;
      --selected-bg: rgba(14, 165, 233, 0.15);
    }

    html, body {
      margin: 0;
      padding: 0;
      overflow: hidden;
      height: 100%;
      background: var(--bg-gradient);
      color: var(--text-main);
      font-family: var(--body-font);
      transition: background 0.5s ease, color 0.5s ease;
    }

    body::before {
      content: "";
      position: fixed;
      inset: 0;
      pointer-events: none;
      background: repeating-linear-gradient(
        to bottom,
        var(--grid-color),
        var(--grid-color) 1px,
        transparent 1px,
        transparent 20px
      );
      z-index: 0;
    }

    /* --- TOP BAR --- */
    #top-bar {
      position: fixed;
      left: 50%;
      top: 18px;
      transform: translateX(-50%);
      z-index: 10;
      display: flex;
      gap: 10px;
      align-items: center;
      background: var(--panel-bg);
      border-radius: 999px;
      padding: 8px 18px;
      border: 1px solid var(--panel-border);
      box-shadow: var(--panel-shadow);
      backdrop-filter: blur(12px);
      -webkit-backdrop-filter: blur(12px);
      font-size: 12px;
      transition: all 0.3s ease;
    }

    #brand {
      display: flex;
      align-items: center;
      gap: 6px;
      font-family: var(--brand-font);
      font-size: 12px;
      letter-spacing: 0.05em;
      font-weight: 600;
      color: var(--text-accent);
      padding-right: 12px;
      border-right: 1px solid var(--panel-border);
    }

    #brand-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: var(--highlight-color);
      box-shadow: 0 0 8px var(--highlight-color);
      animation: pulse 2s ease-in-out infinite;
    }

    @keyframes pulse {
      0%, 100% { opacity: 1; transform: scale(1); }
      50% { opacity: 0.6; transform: scale(0.9); }
    }

    .file-label, select {
      font-size: 11px;
      color: var(--text-main);
      display: flex;
      align-items: center;
      gap: 4px;
      cursor: pointer;
    }

    #themeSelect {
      background: var(--button-bg);
      color: var(--button-text);
      border: 1px solid var(--panel-border);
      border-radius: 6px;
      padding: 4px 8px;
      outline: none;
      font-family: var(--body-font);
      font-size: 11px;
    }

    #fileInput, #bomInput {
      font-size: 11px;
      color: var(--text-muted);
      width: 180px; 
    }
    
    #fileInput::-webkit-file-upload-button,
    #bomInput::-webkit-file-upload-button {
      font-size: 10px;
      padding: 4px 10px;
      border-radius: 999px;
      border: none;
      margin-right: 6px;
      background: var(--highlight-color);
      color: #fff;
      font-weight: 600;
      cursor: pointer;
      text-transform: uppercase;
      transition: filter 0.2s;
    }
    #fileInput::-webkit-file-upload-button:hover,
    #bomInput::-webkit-file-upload-button:hover {
      filter: brightness(1.1);
    }

    #info {
      margin-left: 8px;
      color: var(--text-accent);
      white-space: nowrap;
      max-width: 30vw;
      overflow: hidden;
      text-overflow: ellipsis;
      font-size: 11px;
      font-weight: 600;
    }

    /* --- LEFT TREE PANEL --- */
    #tree-panel {
      position: fixed;
      left: 18px;
      top: 80px;
      bottom: 80px;
      width: 300px;
      background: var(--panel-bg);
      border-radius: 12px;
      border: 1px solid var(--panel-border);
      box-shadow: var(--panel-shadow);
      backdrop-filter: blur(12px);
      z-index: 9;
      display: flex;
      flex-direction: column;
      overflow: hidden;
      transition: all 0.3s ease;
    }

    #tree-header {
      padding: 10px 14px;
      border-bottom: 1px solid var(--panel-border);
      font-family: var(--brand-font);
      font-size: 10px;
      text-transform: uppercase;
      color: var(--text-accent);
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-weight: 600;
    }

    .header-controls button {
      font-size: 9px;
      padding: 3px 8px;
      border-radius: 4px;
      border: 1px solid var(--panel-border);
      background: var(--button-bg);
      color: var(--button-text);
      cursor: pointer;
      transition: all 0.15s;
    }
    .header-controls button:hover {
      background: var(--button-hover);
    }

    #tree-content {
      flex: 1;
      overflow-y: auto;
      padding: 8px;
    }
    #tree-content::-webkit-scrollbar { width: 5px; }
    #tree-content::-webkit-scrollbar-track { background: transparent; }
    #tree-content::-webkit-scrollbar-thumb { background: var(--panel-border); border-radius: 3px; }

    .tree-node { margin: 1px 0; }
    
    .tree-item {
      display: flex;
      align-items: center;
      padding: 4px 6px;
      border-radius: 4px;
      font-size: 11px;
      color: var(--text-main);
      cursor: pointer;
      border: 1px solid transparent;
      user-select: none;
    }

    .tree-item:hover { background: var(--button-bg); }

    .tree-item.selected {
      background: var(--selected-bg);
      border-color: var(--highlight-color);
      color: var(--text-main);
    }

    .tree-item.assembly { font-weight: 600; }
    .tree-item.part { color: var(--text-muted); }
    .tree-item.selected.part { color: var(--text-main); }

    .tree-toggle {
      width: 14px; height: 14px;
      display: flex; align-items: center; justify-content: center;
      margin-right: 4px; font-size: 8px; color: var(--text-accent);
    }
    .tree-toggle.empty { opacity: 0; }
    .tree-icon { margin-right: 6px; font-size: 10px; }
    .tree-label { flex: 1; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
    
    .tree-children {
      margin-left: 14px;
      display: none;
      border-left: 1px solid var(--panel-border);
      padding-left: 4px;
    }
    .tree-children.expanded { display: block; }

    /* --- BOTTOM DETAILS PANEL --- */
    #part-display {
      position: fixed;
      bottom: 24px;
      left: 50%;
      transform: translateX(-50%);
      z-index: 9;
      min-width: 400px;
      max-width: 80vw;
      max-height: 40vh; /* Increased height for more data */
      padding: 16px 20px;
      border-radius: 12px;
      background: var(--panel-bg);
      border: 1px solid var(--panel-border);
      box-shadow: var(--panel-shadow);
      backdrop-filter: blur(12px);
      display: flex;
      flex-direction: column;
      gap: 8px;
      overflow-y: auto;
      transition: all 0.3s ease;
    }

    #part-label {
      font-family: var(--brand-font);
      font-size: 9px;
      text-transform: uppercase;
      letter-spacing: 0.1em;
      color: var(--text-muted);
    }

    #part-value {
      font-family: var(--brand-font);
      font-size: 16px;
      color: var(--text-accent);
      font-weight: 600;
      border-bottom: 1px solid var(--panel-border);
      padding-bottom: 8px;
      margin-bottom: 4px;
    }

    .metadata-grid {
      display: grid;
      grid-template-columns: auto 1fr;
      gap: 4px 12px;
      font-size: 11px;
    }
    .metadata-label { color: var(--text-muted); font-weight: 500; min-width: 80px; }
    .metadata-value { color: var(--text-main); word-break: break-word; font-weight: 600; }
    
    .metadata-section {
      margin-top: 12px;
      padding-top: 6px;
      border-top: 1px dashed var(--panel-border);
    }
    .metadata-section-title {
      font-size: 9px;
      text-transform: uppercase;
      color: var(--text-muted);
      margin-bottom: 6px;
      font-family: var(--brand-font);
      opacity: 0.7;
    }

    #hint {
      position: fixed; right: 18px; bottom: 18px;
      font-size: 10px; opacity: 0.5; color: var(--text-muted);
      z-index: 8; text-align: right; pointer-events: none;
    }
    #hint span { color: var(--text-accent); font-weight: 600;}

    canvas { display: block; position: relative; z-index: 1; outline: none; }

    @media (max-width: 768px) {
      #top-bar { max-width: 90vw; flex-wrap: wrap; justify-content: center; top: 10px; }
      #tree-panel { top: 120px; width: 220px; left: 10px; bottom: 10px; }
      #part-display { bottom: 10px; min-width: 280px; }
      #info { display: none; }
    }
  </style>
</head>
<body>

  <div id="top-bar">
    <div id="brand">
      <div id="brand-dot"></div>
      <span>PART&nbsp;SCAN</span>
    </div>

    <select id="themeSelect">
      <option value="light">Light (Default)</option>
      <option value="dark">Dark Mode</option>
      <option value="neonPurple">Neon Purple</option>
      <option value="neonBlue">Neon Blue</option>
    </select>

    <label class="file-label">
      <input type="file" id="fileInput" accept=".glb,.gltf" />
    </label>
    <!-- RESTRICTED TO CSV and EXCEL ONLY -->
    <label class="file-label">
      <input type="file" id="bomInput" accept=".csv,.xlsx,.xls" />
    </label>
    <span id="info">Loading viewer...</span>
  </div>

  <div id="tree-panel">
    <div id="tree-header">
      <span>Assembly Tree</span>
      <div class="header-controls">
        <button id="expand-all">EXPAND</button>
        <button id="collapse-all">COLLAPSE</button>
      </div>
    </div>
    <div id="tree-content">
      <div style="padding: 20px; text-align: center; font-size: 11px; color: var(--text-muted);">
        Load a GLB/GLTF model
      </div>
    </div>
  </div>

  <div id="part-display">
    <div id="part-label">SELECTED PART</div>
    <div id="part-value">—</div>
    <div id="part-details"></div>
  </div>

  <div id="hint">
    <div>Rotate: <span>Left Drag</span> • Pan: <span>Right/Middle</span></div>
    <div>Zoom: <span>Scroll</span> • Select: <span>Click</span></div>
  </div>

  <!-- Three.js Library -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
  <!-- SheetJS Library for reading Excel files -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  
  <script>
    /* ------------------------------------------------------------------
       THEME MANAGEMENT
       ------------------------------------------------------------------ */
    const themes = {
      light: {
        '--bg-gradient': 'radial-gradient(circle at top, #f8fafc 0, #e2e8f0 100%)',
        '--grid-color': 'rgba(0, 0, 0, 0.05)',
        '--text-main': '#1e293b',
        '--text-muted': '#64748b',
        '--text-accent': '#0284c7',
        '--panel-bg': 'rgba(255, 255, 255, 0.9)',
        '--panel-border': 'rgba(148, 163, 184, 0.4)',
        '--panel-shadow': '0 4px 6px -1px rgba(0, 0, 0, 0.1)',
        '--button-bg': '#f1f5f9',
        '--button-hover': '#e2e8f0',
        '--button-text': '#0f172a',
        '--highlight-color': '#0ea5e9',
        '--selected-bg': 'rgba(14, 165, 233, 0.15)'
      },
      dark: {
        '--bg-gradient': 'radial-gradient(circle at top, #1e293b 0, #0f172a 100%)',
        '--grid-color': 'rgba(255, 255, 255, 0.03)',
        '--text-main': '#f1f5f9',
        '--text-muted': '#94a3b8',
        '--text-accent': '#38bdf8',
        '--panel-bg': 'rgba(30, 41, 59, 0.85)',
        '--panel-border': 'rgba(56, 189, 248, 0.2)',
        '--panel-shadow': '0 0 15px rgba(0,0,0,0.5)',
        '--button-bg': '#334155',
        '--button-hover': '#475569',
        '--button-text': '#f8fafc',
        '--highlight-color': '#38bdf8',
        '--selected-bg': 'rgba(56, 189, 248, 0.15)'
      },
      neonPurple: {
        '--bg-gradient': 'radial-gradient(circle at top, #2e1065 0, #020207 100%)',
        '--grid-color': 'rgba(216, 180, 254, 0.05)',
        '--text-main': '#f3e8ff',
        '--text-muted': '#a855f7',
        '--text-accent': '#d8b4fe',
        '--panel-bg': 'rgba(20, 10, 40, 0.85)',
        '--panel-border': 'rgba(192, 132, 252, 0.4)',
        '--panel-shadow': '0 0 20px rgba(168, 85, 247, 0.2)',
        '--button-bg': 'rgba(168, 85, 247, 0.2)',
        '--button-hover': 'rgba(168, 85, 247, 0.4)',
        '--button-text': '#ffffff',
        '--highlight-color': '#d8b4fe',
        '--selected-bg': 'rgba(216, 180, 254, 0.2)'
      },
      neonBlue: {
        '--bg-gradient': 'radial-gradient(circle at top, #151b3c 0, #020207 100%)',
        '--grid-color': 'rgba(125, 249, 255, 0.03)',
        '--text-main': '#e0f2fe',
        '--text-muted': '#7dd3fc',
        '--text-accent': '#38bdf8',
        '--panel-bg': 'rgba(16, 22, 54, 0.9)',
        '--panel-border': 'rgba(56, 189, 248, 0.3)',
        '--panel-shadow': '0 0 20px rgba(14, 165, 233, 0.25)',
        '--button-bg': 'rgba(168, 189, 248, 0.15)',
        '--button-hover': 'rgba(56, 189, 248, 0.3)',
        '--button-text': '#ffffff',
        '--highlight-color': '#00ffcc',
        '--selected-bg': 'rgba(0, 255, 204, 0.15)'
      }
    };

    const themeSelect = document.getElementById('themeSelect');
    
    function applyTheme(themeName) {
      const t = themes[themeName];
      if (!t) return;
      const root = document.documentElement;
      Object.keys(t).forEach(key => {
        root.style.setProperty(key, t[key]);
      });
    }

    applyTheme('light');
    themeSelect.addEventListener('change', (e) => {
      applyTheme(e.target.value);
    });

    /* ------------------------------------------------------------------
       CORE VIEWER LOGIC
       ------------------------------------------------------------------ */
    const info = document.getElementById('info');
    const fileInput = document.getElementById('fileInput');
    const bomInput = document.getElementById('bomInput');
    const partValue = document.getElementById('part-value');
    const partDetails = document.getElementById('part-details');
    const treeContent = document.getElementById('tree-content');
    const expandAllBtn = document.getElementById('expand-all');
    const collapseAllBtn = document.getElementById('collapse-all');

    let scene, camera, renderer, controls;
    let raycaster, mouse;
    let modelRoot = null;
    let selectedObject = null;
    let originalMaterials = new Map();
    let objectToNodeMap = new Map();
    let bomData = {};

    function checkThree() {
      if (typeof THREE === 'undefined') {
        info.textContent = 'Loading Three.js...';
        setTimeout(checkThree, 100);
        return;
      }
      loadOrbitControls();
    }

    function loadOrbitControls() {
      const script = document.createElement('script');
      script.src = 'https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/controls/OrbitControls.js';
      script.onload = loadGLTFLoader;
      script.onerror = () => { info.textContent = 'Failed to load OrbitControls'; };
      document.head.appendChild(script);
    }

    function loadGLTFLoader() {
      const script = document.createElement('script');
      script.src = 'https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/loaders/GLTFLoader.js';
      script.onload = init;
      script.onerror = () => { info.textContent = 'Failed to load GLTFLoader'; };
      document.head.appendChild(script);
    }

    function init() {
      info.textContent = 'Ready. Load GLB file.';
      scene = new THREE.Scene();
      scene.background = null;

      camera = new THREE.PerspectiveCamera(60, window.innerWidth / window.innerHeight, 0.1, 2000);
      camera.position.set(0, 2, 5);

      renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
      renderer.setPixelRatio(window.devicePixelRatio);
      renderer.setSize(window.innerWidth, window.innerHeight);
      document.body.appendChild(renderer.domElement);

      controls = new THREE.OrbitControls(camera, renderer.domElement);
      controls.enableDamping = true;
      controls.dampingFactor = 0.08;

      const hemi = new THREE.HemisphereLight(0xffffff, 0x444444, 1.2); 
      hemi.position.set(0, 50, 0);
      scene.add(hemi);

      const dir1 = new THREE.DirectionalLight(0xffffff, 0.8);
      dir1.position.set(25, 30, 18);
      scene.add(dir1);

      const dir2 = new THREE.DirectionalLight(0xffffff, 0.5);
      dir2.position.set(-20, -10, -15);
      scene.add(dir2);

      raycaster = new THREE.Raycaster();
      mouse = new THREE.Vector2();

      window.addEventListener('resize', onWindowResize, false);
      renderer.domElement.addEventListener('click', onPointerClick, false);
      fileInput.addEventListener('change', onFileSelected, false);
      bomInput.addEventListener('change', onBomSelected, false);
      expandAllBtn.addEventListener('click', expandAll);
      collapseAllBtn.addEventListener('click', collapseAll);

      animate();
    }

    function onWindowResize() {
      if (!camera || !renderer) return;
      camera.aspect = window.innerWidth / window.innerHeight;
      camera.updateProjectionMatrix();
      renderer.setSize(window.innerWidth, window.innerHeight);
    }

    function normalizeKey(str) {
      if (!str) return '';
      let s = String(str).trim();
      if (s.includes(':')) s = s.split(':')[0].trim();
      return s.toUpperCase();
    }

    // --- BOM PARSING LOGIC (STRICT COLUMN 2) ---
    
    // 1. CSV PARSER (Strictly use Column 2 as Key)
    function parseBomCsv(text) {
      bomData = {};
      const lines = text.split(/\r?\n/).filter(l => l.trim().length > 0);
      if (lines.length < 2) return;
      
      // Get all headers from the first row
      const headersLine = lines[0];
      const headers = headersLine.split(',').map(h => h.trim());
      
      // We assume Column 2 (Index 1) is Part Number based on your file
      if (headers.length < 2) {
         info.textContent = 'Error: CSV must have at least 2 columns.';
         return;
      }

      for (let i = 1; i < lines.length; i++) {
        // Regex split to handle commas inside quotes
        const row = lines[i].split(/,(?=(?:(?:[^"]*"){2})*[^"]*$)/);
        
        // Grab Column 2 (Index 1) - The Part Number
        if (!row[1]) continue; 
        
        const partNumber = row[1].replace(/^"|"$/g, '').trim();
        const key = normalizeKey(partNumber);
        
        bomData[key] = {};
        
        // Store EVERY column mapped to its header
        headers.forEach((header, index) => {
          if (row[index]) {
            let val = row[index].replace(/^"|"$/g, '').trim();
            if (val) bomData[key][header] = val;
          }
        });
      }
    }

    // 2. EXCEL (XLSX) PARSER (Strictly use Column 2 as Key)
    function parseBomExcel(arrayBuffer) {
      bomData = {};
      if (typeof XLSX === 'undefined') {
         info.textContent = 'Excel library not loaded.';
         return;
      }

      const workbook = XLSX.read(arrayBuffer, { type: 'array' });
      const firstSheetName = workbook.SheetNames[0];
      const worksheet = workbook.Sheets[firstSheetName];
      
      // Convert sheet to "Array of Arrays" (Header is row 0)
      const rows = XLSX.utils.sheet_to_json(worksheet, { header: 1, defval: "" });

      if (rows.length < 2) return;

      const headers = rows[0]; // First row is headers

      // Start from index 1 (skip headers)
      for (let i = 1; i < rows.length; i++) {
        const row = rows[i];
        
        // Grab Column 2 (Index 1) - The Part Number
        if (!row[1]) continue;

        const partNumber = String(row[1]).trim();
        const key = normalizeKey(partNumber);
        
        bomData[key] = {};
        
        // Map all columns
        headers.forEach((h, colIndex) => {
           if (row[colIndex] !== undefined) {
             bomData[key][h] = String(row[colIndex]);
           }
        });
      }
    }

    // Handles the file selection event
    function onBomSelected(e) {
      const file = e.target.files[0];
      if (!file) return;
      info.textContent = 'Loading BOM...';
      const reader = new FileReader();
      
      const isExcel = file.name.match(/\.(xlsx|xls)$/i);
      const isCsv = file.name.toLowerCase().endsWith('.csv');

      if (!isExcel && !isCsv) {
        info.textContent = 'Error: Only CSV or Excel files allowed.';
        return;
      }
      
      reader.onload = (ev) => {
        const data = ev.target.result;
        
        if (isExcel) {
          parseBomExcel(data);
        } else if (isCsv) {
          parseBomCsv(data);
        }
        
        info.textContent = `BOM Loaded (${Object.keys(bomData).length} parts).`;
      };

      if (isExcel) {
        reader.readAsArrayBuffer(file);
      } else {
        reader.readAsText(file);
      }
    }

    // --- METADATA MERGING ---
    function extractAllMetadata(obj) {
      const md = { 
        name: 'Unknown', 
        type: obj.isMesh ? 'Part' : 'Assembly',
        partNumber: null,
        geometry: {}, 
        bomProps: {}
      };

      let curr = obj;
      while(curr) {
        if (curr.name && !curr.name.match(/Scene|Solid|Mesh/i)) md.name = curr.name;
        if (curr.userData && curr.userData.partNumber) md.partNumber = curr.userData.partNumber;
        curr = curr.parent;
      }
      
      if (!md.partNumber) md.partNumber = md.name;
      
      const key = normalizeKey(md.partNumber);
      let foundData = bomData[key];

      if (!foundData && md.partNumber.includes(':')) {
        const base = normalizeKey(md.partNumber.split(':')[0]);
        foundData = bomData[base];
      }

      if (foundData) {
        md.bomProps = foundData;
      }

      if (obj.isMesh && obj.geometry) {
         if (!obj.geometry.boundingBox) obj.geometry.computeBoundingBox();
         const size = new THREE.Vector3();
         obj.geometry.boundingBox.getSize(size);
         md.geometry.dims = `${size.x.toFixed(1)} x ${size.y.toFixed(1)} x ${size.z.toFixed(1)}`;
      }
      return md;
    }

    // --- DISPLAY LOGIC ---
    function displayMetadata(md) {
      let html = '<div class="metadata-grid">';
      const add = (l, v) => { 
        if(v) html += `<div class="metadata-label">${l}:</div><div class="metadata-value">${v}</div>`; 
      };
      
      // 1. BOM DATA (Show everything found in Excel/CSV)
      if (Object.keys(md.bomProps).length > 0) {
         Object.keys(md.bomProps).forEach(key => {
           // We can hide the raw 'Part Number' if desired, but here we show everything
           add(key, md.bomProps[key]);
         });
      } else {
         add('Type', md.type);
         html += `<div style="grid-column:1/-1; margin-top:5px; font-size:10px; color:var(--text-muted); font-style:italic;">No BOM data found. Check Column 2 of your file.</div>`;
      }
      
      html += '</div>';

      // 2. GEOMETRY (Pushed to bottom)
      if (md.geometry.dims) {
        html += `<div class="metadata-section"><div class="metadata-section-title">Geometric Data</div><div class="metadata-grid">`;
        add('Dimensions', md.geometry.dims);
        html += `</div></div>`;
      }
      
      partDetails.innerHTML = html;
    }

    // --- TREE BUILDER ---
    function buildTreeNode(obj, parentEl) {
      if (!obj.name || obj.name.match(/Scene/i)) {
        obj.children.forEach(c => buildTreeNode(c, parentEl));
        return;
      }
      const node = document.createElement('div');
      node.className = 'tree-node';
      const item = document.createElement('div');
      const hasKids = obj.children && obj.children.some(c => c.name);
      item.className = `tree-item ${hasKids?'assembly':'part'}`;
      
      const toggle = document.createElement('span');
      toggle.className = `tree-toggle ${hasKids?'':'empty'}`;
      toggle.textContent = hasKids ? '▶' : '';
      
      const label = document.createElement('span');
      label.className = 'tree-label';
      label.textContent = obj.name;

      item.append(toggle, label);
      node.append(item);

      if (hasKids) {
        const kidsContainer = document.createElement('div');
        kidsContainer.className = 'tree-children';
        obj.children.forEach(c => buildTreeNode(c, kidsContainer));
        node.append(kidsContainer);
        toggle.onclick = (e) => {
          e.stopPropagation();
          kidsContainer.classList.toggle('expanded');
          toggle.textContent = kidsContainer.classList.contains('expanded') ? '▼' : '▶';
        };
      }
      if (obj.isMesh || hasKids) {
        item.onclick = (e) => {
          if (e.target === toggle) return;
          selectObject(obj);
        };
        if (obj.isMesh) objectToNodeMap.set(obj, item);
      }
      parentEl.appendChild(node);
    }

    function expandAll() {
      document.querySelectorAll('.tree-children').forEach(c => c.classList.add('expanded'));
      document.querySelectorAll('.tree-toggle').forEach(t => { if(t.textContent === '▶') t.textContent = '▼'; });
    }
    function collapseAll() {
      document.querySelectorAll('.tree-children').forEach(c => c.classList.remove('expanded'));
      document.querySelectorAll('.tree-toggle').forEach(t => { if(t.textContent === '▼') t.textContent = '▶'; });
    }

    // --- INTERACTION ---
    function selectObject(obj) {
      let mesh = obj.isMesh ? obj : null;
      if (!mesh) obj.traverse(c => { if(c.isMesh && !mesh) mesh = c; });
      
      if (mesh) {
        highlight(mesh);
        const md = extractAllMetadata(mesh);
        partValue.textContent = md.partNumber || md.name;
        displayMetadata(md);
        
        document.querySelectorAll('.tree-item.selected').forEach(el => el.classList.remove('selected'));
        const node = objectToNodeMap.get(mesh);
        if (node) {
          node.classList.add('selected');
          node.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        }
        
        const box = new THREE.Box3().setFromObject(mesh);
        controls.target.copy(box.getCenter(new THREE.Vector3()));
      }
    }

    function highlight(mesh) {
      if (selectedObject && originalMaterials.has(selectedObject)) {
        selectedObject.material = originalMaterials.get(selectedObject);
      }
      selectedObject = mesh;
      const highlightHex = getComputedStyle(document.body).getPropertyValue('--highlight-color').trim();
      const mat = mesh.material.clone();
      mat.emissive = new THREE.Color(highlightHex);
      mat.emissiveIntensity = 0.6;
      mesh.material = mat;
    }

    function onFileSelected(e) {
      const file = e.target.files[0];
      if (!file) return;
      info.textContent = 'Loading GLB...';
      const url = URL.createObjectURL(file);
      const loader = new THREE.GLTFLoader();
      
      loader.load(url, (gltf) => {
        if (modelRoot) scene.remove(modelRoot);
        modelRoot = gltf.scene;
        scene.add(modelRoot);
        
        const box = new THREE.Box3().setFromObject(modelRoot);
        const center = box.getCenter(new THREE.Vector3());
        modelRoot.position.sub(center);
        
        const size = box.getSize(new THREE.Vector3());
        const maxDim = Math.max(size.x, size.y, size.z);
        camera.position.set(maxDim, maxDim, maxDim*1.5);
        camera.lookAt(0,0,0);
        
        originalMaterials.clear();
        modelRoot.traverse(c => {
          if (c.isMesh) originalMaterials.set(c, c.material);
        });

        treeContent.innerHTML = '';
        objectToNodeMap.clear();
        buildTreeNode(modelRoot, treeContent);
        
        info.textContent = 'Model Loaded.';
        partDetails.innerHTML = '<div style="font-size:11px; color:var(--text-muted)">Select a part</div>';
      }, undefined, (err) => { console.error(err); info.textContent = 'Error loading.'; });
    }

    function onPointerClick(e) {
      if (!modelRoot) return;
      const rect = renderer.domElement.getBoundingClientRect();
      mouse.x = ((e.clientX - rect.left) / rect.width) * 2 - 1;
      mouse.y = -((e.clientY - rect.top) / rect.height) * 2 + 1;
      
      raycaster.setFromCamera(mouse, camera);
      const intersects = raycaster.intersectObjects(modelRoot.children, true);
      
      if (intersects.length > 0) {
        selectObject(intersects[0].object);
      } else {
        if (selectedObject && originalMaterials.has(selectedObject)) {
          selectedObject.material = originalMaterials.get(selectedObject);
          selectedObject = null;
        }
        document.querySelectorAll('.tree-item.selected').forEach(el => el.classList.remove('selected'));
        partValue.textContent = '—';
        partDetails.innerHTML = '';
      }
    }

    function animate() {
      requestAnimationFrame(animate);
      if (controls) controls.update();
      if (renderer && scene && camera) renderer.render(scene, camera);
    }

    checkThree();
  </script>
</body>
</html>