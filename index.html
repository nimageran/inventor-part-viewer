<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Inventor Part Scanner - SciFi HUD</title>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@400;600;800&family=Rajdhani:wght@400;600&display=swap');

    /* ------------------------------------------------------------------
       THEME VARIABLES
       ------------------------------------------------------------------ */
    :root {
      /* Base Theme Colors */
      --bg-gradient: radial-gradient(circle at center, #1a1a2e 0%, #0f0f1a 100%);
      
      /* HUD Colors */
      --hud-bg: rgba(5, 10, 20, 0.85);
      --hud-border: rgba(0, 255, 213, 0.6);
      --hud-glow: rgba(0, 255, 213, 0.3);
      --hud-text-main: #e0f2fe;
      --hud-text-accent: #00ffd5;
      
      --panel-bg: rgba(20, 25, 40, 0.6);
      --panel-border: rgba(100, 116, 139, 0.3);
      
      --font-tech: "Orbitron", sans-serif;
      --font-data: "Rajdhani", sans-serif;
    }

    html, body {
      margin: 0;
      padding: 0;
      overflow: hidden;
      height: 100%;
      background: var(--bg-gradient);
      color: var(--hud-text-main);
      font-family: var(--font-data);
    }

    /* Grid Background */
    body::before {
      content: "";
      position: fixed;
      inset: 0;
      pointer-events: none;
      background: 
        linear-gradient(rgba(0, 255, 213, 0.03) 1px, transparent 1px),
        linear-gradient(90deg, rgba(0, 255, 213, 0.03) 1px, transparent 1px);
      background-size: 40px 40px;
      z-index: 0;
    }

    /* --- TOP BAR --- */
    #top-bar {
      position: fixed;
      left: 50%;
      top: 20px;
      transform: translateX(-50%);
      z-index: 10;
      display: flex;
      gap: 15px;
      align-items: center;
      background: var(--panel-bg);
      border: 1px solid var(--panel-border);
      border-radius: 4px;
      padding: 8px 20px;
      backdrop-filter: blur(8px);
      box-shadow: 0 4px 20px rgba(0,0,0,0.3);
    }

    #brand {
      font-family: var(--font-tech);
      font-size: 14px;
      font-weight: 800;
      color: var(--hud-text-accent);
      letter-spacing: 2px;
      text-shadow: 0 0 10px var(--hud-glow);
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .file-input-wrapper {
      position: relative;
      overflow: hidden;
      display: inline-block;
    }

    input[type="file"] {
      font-size: 100px;
      position: absolute;
      left: 0;
      top: 0;
      opacity: 0;
      cursor: pointer;
    }

    .btn-hud {
      background: rgba(0, 255, 213, 0.1);
      border: 1px solid var(--hud-border);
      color: var(--hud-text-accent);
      padding: 5px 12px;
      font-family: var(--font-tech);
      font-size: 10px;
      text-transform: uppercase;
      letter-spacing: 1px;
      cursor: pointer;
      transition: all 0.2s;
      box-shadow: 0 0 5px var(--hud-glow);
    }
    .btn-hud:hover {
      background: rgba(0, 255, 213, 0.2);
      box-shadow: 0 0 15px var(--hud-glow);
    }

    #info {
      font-size: 12px;
      color: var(--hud-text-main);
      font-weight: 600;
      min-width: 150px;
      text-align: right;
    }

    /* --- LEFT TREE PANEL --- */
    #tree-panel {
      position: fixed;
      left: 20px;
      top: 80px;
      bottom: 20px;
      width: 280px;
      background: rgba(10, 15, 25, 0.8);
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-left: 2px solid var(--hud-text-accent);
      backdrop-filter: blur(10px);
      z-index: 9;
      display: flex;
      flex-direction: column;
    }
    
    #tree-header {
      padding: 12px;
      background: rgba(0, 255, 213, 0.05);
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
      font-family: var(--font-tech);
      font-size: 11px;
      color: var(--hud-text-accent);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    #tree-content {
      flex: 1;
      overflow-y: auto;
      padding: 10px;
      font-family: var(--font-data);
    }
    /* Scrollbar */
    #tree-content::-webkit-scrollbar { width: 6px; }
    #tree-content::-webkit-scrollbar-track { background: #0f0f1a; }
    #tree-content::-webkit-scrollbar-thumb { background: #334; }

    .tree-item {
      padding: 4px 6px;
      cursor: pointer;
      font-size: 14px;
      color: #aaa;
      border: 1px solid transparent;
      margin-bottom: 2px;
    }
    .tree-item:hover { color: #fff; background: rgba(255,255,255,0.05); }
    .tree-item.selected {
      background: rgba(0, 255, 213, 0.15);
      border: 1px solid var(--hud-border);
      color: var(--hud-text-accent);
      box-shadow: inset 0 0 10px rgba(0, 255, 213, 0.1);
    }
    .tree-toggle { width: 14px; display: inline-block; color: var(--hud-text-accent); font-size: 10px; }
    .tree-children { margin-left: 12px; display: none; border-left: 1px dashed #334; }
    .tree-children.expanded { display: block; }


    /* --- FUTURISTIC HUD PANEL (Part Display) --- */
    #part-display {
      position: fixed;
      bottom: 30px;
      right: 30px; /* Moved to right for better HUD feel */
      width: 350px;
      min-height: 200px;
      z-index: 20;
      
      background: var(--hud-bg);
      border: 1px solid var(--hud-border);
      box-shadow: 0 0 20px var(--hud-glow), inset 0 0 20px rgba(0, 0, 0, 0.5);
      backdrop-filter: blur(5px);
      
      padding: 20px;
      display: flex;
      flex-direction: column;
      gap: 10px;
      
      /* Clip path for sci-fi shape */
      clip-path: polygon(
        0 0, 
        100% 0, 
        100% 85%, 
        92% 100%, 
        0 100%
      );
    }

    /* HUD Corner Accents */
    #part-display::before {
      content: "";
      position: absolute;
      top: 0; left: 0; width: 100%; height: 100%;
      pointer-events: none;
      border-top: 2px solid var(--hud-text-accent);
      border-left: 2px solid var(--hud-text-accent);
      width: 20px; height: 20px;
    }
    #part-display::after {
      content: "";
      position: absolute;
      bottom: 0; right: 0;
      pointer-events: none;
      border-bottom: 2px solid var(--hud-text-accent);
      border-right: 2px solid var(--hud-text-accent);
      width: 30px; height: 30px; /* larger corner on cut side */
    }

    /* Scanline Animation */
    .scan-line {
      position: absolute;
      top: 0; left: 0; width: 100%; height: 5px;
      background: rgba(0, 255, 213, 0.5);
      opacity: 0.3;
      animation: scan 4s linear infinite;
      pointer-events: none;
    }
    @keyframes scan {
      0% { top: -10%; opacity: 0; }
      10% { opacity: 0.5; }
      90% { opacity: 0.5; }
      100% { top: 110%; opacity: 0; }
    }

    /* HUD Header */
    #part-header {
      border-bottom: 1px solid var(--hud-border);
      padding-bottom: 8px;
      margin-bottom: 8px;
    }
    
    #part-label {
      font-family: var(--font-tech);
      font-size: 10px;
      color: var(--hud-text-accent);
      letter-spacing: 2px;
      text-transform: uppercase;
      opacity: 0.8;
    }
    
    #part-value {
      font-family: var(--font-tech);
      font-size: 18px;
      color: #fff;
      text-transform: uppercase;
      text-shadow: 0 0 8px var(--hud-glow);
      margin-top: 4px;
      word-break: break-all;
    }

    /* Data Grid */
    .hud-grid {
      display: grid;
      grid-template-columns: 1fr;
      gap: 8px;
    }

    .hud-row {
      display: flex;
      justify-content: space-between;
      align-items: baseline;
      border-bottom: 1px solid rgba(0, 255, 213, 0.1);
      padding-bottom: 4px;
    }

    .hud-key {
      font-family: var(--font-tech);
      font-size: 10px;
      color: var(--hud-text-accent);
      text-transform: uppercase;
      letter-spacing: 1px;
    }

    .hud-val {
      font-family: var(--font-data);
      font-size: 14px;
      font-weight: 600;
      color: #fff;
      text-align: right;
    }

    #hint {
      position: fixed; bottom: 20px; left: 20px;
      font-family: var(--font-tech);
      font-size: 10px; color: rgba(255,255,255,0.4);
      pointer-events: none;
    }
  </style>
</head>
<body>

  <div id="top-bar">
    <div id="brand">PART // SCANNER</div>
    
    <label class="btn-hud file-input-wrapper">
      LOAD GLB
      <input type="file" id="fileInput" accept=".glb,.gltf" />
    </label>
    
    <label class="btn-hud file-input-wrapper">
      LOAD CSV BOM
      <input type="file" id="bomInput" accept=".csv,.xlsx,.xls" />
    </label>
    
    <div id="info">SYSTEM READY</div>
  </div>

  <div id="tree-panel">
    <div id="tree-header">
      <span>ASSEMBLY HIERARCHY</span>
      <div style="display:flex; gap:5px;">
        <button id="expand-all" class="btn-hud" style="font-size:9px; padding:2px 6px;">+</button>
        <button id="collapse-all" class="btn-hud" style="font-size:9px; padding:2px 6px;">-</button>
      </div>
    </div>
    <div id="tree-content">
      <div style="padding:20px; text-align:center; opacity:0.5;">NO DATA STREAM</div>
    </div>
  </div>

  <div id="part-display">
    <div class="scan-line"></div>
    <div id="part-header">
      <div id="part-label">TARGET IDENTIFIED</div>
      <div id="part-value">--</div>
    </div>
    <div id="part-details">
      <div style="font-size:12px; color:rgba(255,255,255,0.3); font-style:italic;">AWAITING SELECTION...</div>
    </div>
  </div>

  <div id="hint">
    ORBIT: LEFT CLICK // PAN: RIGHT CLICK // ZOOM: SCROLL
  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/controls/OrbitControls.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/loaders/GLTFLoader.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  
  <script>
    // --- VARIABLES ---
    let scene, camera, renderer, controls;
    let raycaster = new THREE.Raycaster();
    let mouse = new THREE.Vector2();
    let modelRoot = null;
    let selectedObject = null;
    let originalMaterials = new Map();
    let objectToNodeMap = new Map();
    let bomData = {};
    
    const info = document.getElementById('info');
    const partValue = document.getElementById('part-value');
    const partDetails = document.getElementById('part-details');

    // --- INIT SCENE ---
    function init() {
      scene = new THREE.Scene();
      
      // Camera
      camera = new THREE.PerspectiveCamera(60, window.innerWidth / window.innerHeight, 0.1, 2000);
      camera.position.set(2, 2, 4);
      
      // Renderer
      renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
      renderer.setPixelRatio(window.devicePixelRatio);
      renderer.setSize(window.innerWidth, window.innerHeight);
      document.body.appendChild(renderer.domElement);
      
      // Controls
      controls = new THREE.OrbitControls(camera, renderer.domElement);
      controls.enableDamping = true;
      controls.dampingFactor = 0.08;

      // Lights
      const ambient = new THREE.AmbientLight(0xffffff, 0.6);
      scene.add(ambient);
      const dirLight = new THREE.DirectionalLight(0xffffff, 0.8);
      dirLight.position.set(10, 20, 10);
      scene.add(dirLight);

      // Events
      window.addEventListener('resize', onResize);
      renderer.domElement.addEventListener('click', onClick);
      document.getElementById('fileInput').addEventListener('change', loadGLB);
      document.getElementById('bomInput').addEventListener('change', loadBOM);
      document.getElementById('expand-all').addEventListener('click', () => toggleTree(true));
      document.getElementById('collapse-all').addEventListener('click', () => toggleTree(false));

      animate();
    }

    function onResize() {
      camera.aspect = window.innerWidth / window.innerHeight;
      camera.updateProjectionMatrix();
      renderer.setSize(window.innerWidth, window.innerHeight);
    }

    function animate() {
      requestAnimationFrame(animate);
      controls.update();
      renderer.render(scene, camera);
    }

    // --- NORMALIZATION ---
    function normalizeKey(str) {
      if (!str) return '';
      let s = String(str).trim();
      s = s.replace(/\.(ipt|iam|glb|gltf|obj)$/i, '');
      if (s.includes(':')) s = s.split(':')[0].trim();
      return s.toUpperCase();
    }

    // --- FILE LOADING ---
    function loadGLB(e) {
      const file = e.target.files[0];
      if (!file) return;
      info.textContent = "INITIALIZING UPLOAD...";
      
      const loader = new THREE.GLTFLoader();
      loader.load(URL.createObjectURL(file), (gltf) => {
        if (modelRoot) scene.remove(modelRoot);
        modelRoot = gltf.scene;
        scene.add(modelRoot);
        
        // Center model
        const box = new THREE.Box3().setFromObject(modelRoot);
        const center = box.getCenter(new THREE.Vector3());
        const size = box.getSize(new THREE.Vector3());
        modelRoot.position.sub(center);
        
        // Adjust Camera
        const maxDim = Math.max(size.x, size.y, size.z);
        camera.position.set(maxDim, maxDim, maxDim*1.5);
        camera.lookAt(0,0,0);

        // Map Materials & Build Tree
        originalMaterials.clear();
        objectToNodeMap.clear();
        document.getElementById('tree-content').innerHTML = '';
        
        modelRoot.traverse(node => {
          if (node.isMesh) originalMaterials.set(node, node.material);
        });
        
        buildTree(modelRoot, document.getElementById('tree-content'));
        info.textContent = "VISUALIZATION ONLINE";
      }, undefined, (err) => { console.error(err); info.textContent = "UPLOAD FAILED"; });
    }

    function loadBOM(e) {
      const file = e.target.files[0];
      if (!file) return;
      info.textContent = "PARSING DATA...";
      
      const reader = new FileReader();
      reader.onload = (ev) => {
        const data = ev.target.result;
        // Basic CSV/XLSX detection logic from before (simplified here for brevity)
        if (file.name.endsWith('.csv')) parseCSV(data);
        else parseXLSX(data);
        info.textContent = `DATABASE UPDATED (${Object.keys(bomData).length} RECORDS)`;
      };
      
      if (file.name.endsWith('.csv')) reader.readAsText(file);
      else reader.readAsArrayBuffer(file);
    }

    // --- PARSERS ---
    function parseCSV(text) {
      bomData = {};
      const lines = text.split(/\r?\n/).filter(l => l.trim());
      if (lines.length < 2) return;
      const headers = lines[0].split(',').map(h => h.trim().replace(/^"|"$/g, ''));
      const idx = headers.findIndex(h => h.toLowerCase().includes('part') && h.toLowerCase().includes('nu'));
      
      if (idx === -1) return alert("Missing 'Part Number' header");

      for (let i = 1; i < lines.length; i++) {
        // Simple comma split (robust regex in previous versions if needed)
        const row = lines[i].split(/,(?=(?:(?:[^"]*"){2})*[^"]*$)/);
        if (row[idx]) {
          const key = normalizeKey(row[idx].replace(/^"|"$/g, ''));
          bomData[key] = {};
          headers.forEach((h, j) => {
            if (row[j]) bomData[key][h] = row[j].replace(/^"|"$/g, '');
          });
        }
      }
    }

    function parseXLSX(buffer) {
      bomData = {};
      const wb = XLSX.read(buffer, {type:'array'});
      const ws = wb.Sheets[wb.SheetNames[0]];
      const json = XLSX.utils.sheet_to_json(ws);
      if(!json.length) return;
      
      const keyCol = Object.keys(json[0]).find(k => k.toLowerCase().includes('part') && k.toLowerCase().includes('nu'));
      if(!keyCol) return;

      json.forEach(row => {
        if (row[keyCol]) {
          const key = normalizeKey(row[keyCol]);
          bomData[key] = {};
          Object.keys(row).forEach(k => bomData[key][k] = String(row[k]));
        }
      });
    }

    // --- INTERACTION ---
    function onClick(e) {
      if (!modelRoot) return;
      // Calculate mouse
      const rect = renderer.domElement.getBoundingClientRect();
      mouse.x = ((e.clientX - rect.left) / rect.width) * 2 - 1;
      mouse.y = -((e.clientY - rect.top) / rect.height) * 2 + 1;
      
      raycaster.setFromCamera(mouse, camera);
      const intersects = raycaster.intersectObjects(modelRoot.children, true);
      
      if (intersects.length > 0) {
        selectPart(intersects[0].object);
      } else {
        deselect();
      }
    }

    function selectPart(obj) {
      // Highlight 3D
      if (selectedObject && originalMaterials.has(selectedObject)) {
        selectedObject.material = originalMaterials.get(selectedObject);
      }
      // Find mesh root
      let target = obj;
      while(target.parent && !target.isMesh) target = target.parent;
      if(!target.isMesh) return; // safety

      selectedObject = target;
      const mat = target.material.clone();
      mat.emissive = new THREE.Color(0x00ffd5);
      mat.emissiveIntensity = 0.5;
      target.material = mat;

      // Update UI
      // 1. Get Name/Number
      let name = target.name;
      if (target.userData && target.userData.partNumber) name = target.userData.partNumber;
      
      // 2. Lookup BOM
      const key = normalizeKey(name);
      // Fallback: try stripping after ':'
      let data = bomData[key] || bomData[key.split(':')[0]];
      
      partValue.textContent = name;
      renderHUD(data);

      // 3. Highlight Tree
      document.querySelectorAll('.tree-item').forEach(el => el.classList.remove('selected'));
      const treeNode = objectToNodeMap.get(target);
      if (treeNode) {
        treeNode.classList.add('selected');
        treeNode.scrollIntoView({ block: 'nearest' });
      }
    }

    function deselect() {
      if (selectedObject && originalMaterials.has(selectedObject)) {
        selectedObject.material = originalMaterials.get(selectedObject);
      }
      selectedObject = null;
      partValue.textContent = "--";
      partDetails.innerHTML = '<div style="font-size:12px; color:rgba(255,255,255,0.3); font-style:italic;">AWAITING SELECTION...</div>';
      document.querySelectorAll('.tree-item').forEach(el => el.classList.remove('selected'));
    }

    function renderHUD(data) {
      if (!data) {
        partDetails.innerHTML = '<div style="color:var(--hud-text-accent); opacity:0.7;">NO DATABASE RECORD FOUND</div>';
        return;
      }

      let html = '<div class="hud-grid">';
      
      // Priority Keys to show at top
      const priority = ['Description', 'QTY', 'Rev', 'Stock Number', 'Material'];
      
      // 1. Render Priority
      priority.forEach(p => {
        // Find key regardless of case
        const realKey = Object.keys(data).find(k => k.toLowerCase() === p.toLowerCase());
        if (realKey && data[realKey]) {
           html += `
             <div class="hud-row">
               <span class="hud-key">${realKey}</span>
               <span class="hud-val">${data[realKey]}</span>
             </div>`;
        }
      });

      // 2. Render Others
      Object.keys(data).forEach(k => {
        const isPriority = priority.some(p => p.toLowerCase() === k.toLowerCase());
        const isExcluded = k.toLowerCase().includes('part number') || k.toLowerCase().includes('thumbnail');
        
        if (!isPriority && !isExcluded && data[k]) {
          html += `
             <div class="hud-row">
               <span class="hud-key">${k}</span>
               <span class="hud-val">${data[k]}</span>
             </div>`;
        }
      });

      html += '</div>';
      partDetails.innerHTML = html;
    }

    // --- TREE VIEW ---
    function buildTree(obj, container) {
      if (!obj.name || obj.name.includes('Scene')) {
        obj.children.forEach(c => buildTree(c, container));
        return;
      }
      
      const node = document.createElement('div');
      const item = document.createElement('div');
      const hasKids = obj.children.length > 0;
      
      item.className = 'tree-item';
      item.innerHTML = `
        <span class="tree-toggle">${hasKids ? '▶' : '•'}</span>
        <span>${obj.name}</span>
      `;
      node.appendChild(item);

      if (hasKids) {
        const kidsDiv = document.createElement('div');
        kidsDiv.className = 'tree-children';
        obj.children.forEach(c => buildTree(c, kidsDiv));
        node.appendChild(kidsDiv);
        
        item.querySelector('.tree-toggle').onclick = (e) => {
          e.stopPropagation();
          kidsDiv.classList.toggle('expanded');
          e.target.textContent = kidsDiv.classList.contains('expanded') ? '▼' : '▶';
        };
      }

      if (obj.isMesh) {
        objectToNodeMap.set(obj, item);
        item.onclick = (e) => {
           if(e.target.classList.contains('tree-toggle')) return;
           selectPart(obj);
        };
      }
      
      container.appendChild(node);
    }
    
    function toggleTree(expand) {
      document.querySelectorAll('.tree-children').forEach(el => {
        if(expand) el.classList.add('expanded');
        else el.classList.remove('expanded');
      });
      document.querySelectorAll('.tree-toggle').forEach(el => {
        if(el.textContent !== '•') el.textContent = expand ? '▼' : '▶';
      });
    }

    init();
  </script>
</body>
</html>